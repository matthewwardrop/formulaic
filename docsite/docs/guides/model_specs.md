Hi @laserson ,

Sorry for the delay. I must have missed the notification! And thanks for reaching out.

Yes, this is presently possible. You can do, for example:

model_matrix("y ~ C(x, contr.treatment(base='ref'))",...)

You can omit base= if you like.

I'll leave this issue open until the documention has been updated, and let me know if you have any other questions!

Best,
M

Hi! The column names are available on the (wrapped) sparse matrix using: <output>.model_spec.feature_names. This isn't thoroughly documented mainly because I need to review the API, which I will do soon. I'll leave this here as a reminder to add documentation about this!


Hi @petrhrobar ,

Yes... this is easily done with the current state of formulaic.

You can just do:

from formulaic import Formula

df = pandas.DataFrame({
    'y': [0,1,2],
    'x': ['A', 'B', 'C'],
    'z': [0.3, 0.1, 0.2],
})

trans = Formula('y ~ x + z')

mm1 = trans.get_model_matrix(df)

df2 = pandas.DataFrame({
    'y': [3, 3, 3],
    'x': ['A', 'B', 'B'],
    'z': [0.3, 0.1, 0.222222222],
})

mm2 = mm1.model_spec.get_model_matrix(df2)

Or, using the sugar method model_matrix in 0.3.4+:

mm2 = model_matrix(mm1, df2)

Hope that helps. I'll leave this open for documentation purposes until the docsite is updated.


Yes! This is doable in formulaic, but again... ahem... documentation.

import pandas
from formulaic import model_matrix

# Option 1:
model_matrix('cat', pandas.DataFrame({'cat': pandas.Categorical(['a', 'b'], categories=['a', 'b', 'c'])}))

# Option 2:
model_matrix('C(cat, levels=["a", "b", "c"])', pandas.DataFrame({'cat': ['a', 'b']}))


Hi @klaapbakken ! This functionality is indeed supported via the ModelSpec class. You can access the ModelSpec instance associated with a model matrix generated by get_model_matrix, e.g.:

from formulaic import model_matrix

df = ....
mm  = model_matrix('y ~ x', df)
ms = mm.model_spec

You can then use that model spec to generate a new model matrix from new data using:

mm2 = ms.get_model_matrix(df2)

Hope that helps! In lieu of better documentation (still coming!), you can view the ModelSpec class here: master/formulaic/model_spec.py
klaapbakken reacted with thumbs up emoji


Add detail about how to access model spec on generated matrices.